<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CoinPulse BTC Chart</title>

  <!-- 1) Chart.js core -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- 2a) Luxon (date library) -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <!-- 2b) Chart.js–Luxon adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1/dist/chartjs-adapter-luxon.min.js"></script>

  <style>
    body { margin:0; background:#1e1e1e; color:#fff; font-family:sans-serif; }
    #controls {  
      display:flex; justify-content:center; align-items:center;
      gap:8px; padding:10px; background:#2a2a2a;
    }
    #controls input {
      width:200px; padding:6px; border:none;
      border-radius:4px; background:#333; color:#fff;
    }
    #chartContainer {
      width:100vw; height:calc(100vh - 52px); /* adjust for controls */
    }
    canvas { width:100% !important; height:100% !important; }
  </style>
</head>
<body>

  <div id="controls">
    <input type="text" id="coinSearch" placeholder="Search top 100 coins…">
    <button data-days="1">1D</button>
    <button data-days="7">7D</button>
    <button data-days="30" class="active">30D</button>
    <button data-days="90">3M</button>
    <button data-days="180">6M</button>
    <button data-days="365">1Y</button>
    <button id="volToggle">Show Volume</button>
  </div>

  <div id="chartContainer">
    <canvas id="priceChart"></canvas>
  </div>

  <script>
  // ————————————————————————————————————————————  
  // 1) Setup & Globals
  const ctx      = document.getElementById('priceChart').getContext('2d');
  const search   = document.getElementById('coinSearch');
  const volBtn   = document.getElementById('volToggle');
  let chart, coins=[], current='bitcoin', activeDays=30;

  // 2) Fetch top 100 coins for search
  fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100')
    .then(r=>r.json())
    .then(data=> coins = data.map(c=>({id:c.id, name:c.name, sym:c.symbol})));

  // 3) Autocomplete simple
  search.addEventListener('input',()=>{
    const val = search.value.toLowerCase();
    const match = coins.find(c=>c.name.toLowerCase().includes(val) || c.sym.includes(val));
    if(match) {
      current = match.id;
      loadChart(activeDays);
    }
  });

  // 4) Range buttons
  document.querySelectorAll('#controls button[data-days]')
    .forEach(btn=>btn.addEventListener('click',()=>{
      activeDays = btn.dataset.days;
      document.querySelectorAll('#controls button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      loadChart(activeDays);
    }));

  // 5) Volume toggle
  volBtn.addEventListener('click',()=>{
    const vis = chart.isDatasetVisible(1);
    chart.setDatasetVisibility(1, !vis);
    chart.options.scales.y1.display = !vis;
    volBtn.textContent = vis ? 'Show Volume':'Hide Volume';
    chart.update();
  });

  // 6) Fetch & transform data from CoinGecko
  async function getData(days) {
    const res = await fetch(`https://api.coingecko.com/api/v3/coins/${current}/market_chart?vs_currency=usd&days=${days}`);
    const js  = await res.json();
    return {
      prices: js.prices.map(p=>({x:p[0], y:p[1]})),
      volumes: js.total_volumes.map(v=>({x:v[0], y:v[1]}))
    };
  }

  // 7) Initialize or update Chart.js
  async function loadChart(days) {
    const {prices, volumes} = await getData(days);
    if(chart) {
      chart.data.datasets[0].data = prices;
      chart.data.datasets[1].data = volumes;
      chart.update();
    } else {
      chart = new Chart(ctx, {
        data: {
          datasets: [
            { type:'line',  label:'Price (USD)', data:prices,
              borderColor:'#FFA500', backgroundColor:'rgba(255,165,0,0.2)',
              pointRadius:0, tension:0.2, yAxisID:'y' },
            { type:'bar', label:'Volume', data:volumes, hidden:true,
              backgroundColor:'rgba(255,165,0,0.3)', yAxisID:'y1' }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          scales: {
            x: { type:'time', time:{unit:'day'}, ticks:{color:'#ccc'} },
            y: { position:'left', ticks:{color:'#fff'} },
            y1:{ position:'right', display:false, ticks:{color:'#fff'} }
          },
          plugins:{
            tooltip:{mode:'index', intersect:false},
            legend:{display:false}
          }
        }
      });
    }
  }

  // 8) Kick it off
  loadChart(activeDays);
  </script>
</body>
</html>
