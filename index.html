<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CoinPulse â€“ Bitcoin Price Chart</title>
  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Luxon date library and Chart.js Luxon adapter for time axis -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.6.1/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
  <style>
    /* Global page styles */
    html, body {
      margin: 0;
      height: 100%;
      background: #1e1e1e;
      color: #ffffff;
      font-family: Arial, sans-serif;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    /* Control bar */
    #controls {
      padding: 10px;
      text-align: center;
    }
    #controls button {
      background: #333;
      border: none;
      color: #fff;
      font-weight: bold;
      padding: 8px 12px;
      margin: 4px;
      border-radius: 4px;
      cursor: pointer;
    }
    #controls button.active {
      background: #FFA500;
      color: #000;
    }
    /* Chart container fills the remaining space */
    #chart-container {
      flex: 1;
      position: relative;
    }
    /* Make canvas fill its container */
    #chart {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>
  
  <!-- Controls: Time range buttons and volume toggle -->
  <div id="controls">
    <button class="range-btn active" data-days="30">1M</button>
    <button class="range-btn" data-days="1">1D</button>
    <button class="range-btn" data-days="7">7D</button>
    <button class="range-btn" data-days="30">30D</button>
    <button class="range-btn" data-days="90">3M</button>
    <button class="range-btn" data-days="180">6M</button>
    <button class="range-btn" data-days="365">1Y</button>
    <button id="volume-toggle">Show Volume</button>
  </div>
  
  <!-- Chart Canvas -->
  <div id="chart-container">
    <canvas id="chart"></canvas>
  </div>
  
  <script>
    const API_URL = "https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=";
    const ctx = document.getElementById('chart').getContext('2d');
    let chart;  // will hold the Chart.js instance
    
    // Function to fetch data from CoinGecko API for a given number of days
    async function fetchCoinData(days) {
      const response = await fetch(API_URL + days);
      if (!response.ok) {
        console.error("Error fetching data from CoinGecko API");
        return null;
      }
      const data = await response.json();
      return transformData(data);
    }
    
    // Transform raw API data into format suitable for Chart.js (array of {x, y} points)
    function transformData(data) {
      const prices = data.prices || [];
      const volumes = data.total_volumes || [];
      return {
        prices: prices.map(pt => {
          const t = pt[0] < 1e12 ? pt[0] * 1000 : pt[0];  // ensure timestamp in ms
          return { x: t, y: pt[1] };
        }),
        volumes: volumes.map(pt => {
          const t = pt[0] < 1e12 ? pt[0] * 1000 : pt[0];
          return { x: t, y: pt[1] };
        })
      };
    }
    
    // Initialize the chart with given data (price and volume arrays)
    function initChart(data) {
      chart = new Chart(ctx, {
        data: {
          datasets: [
            {
              type: 'line',
              label: 'Price (USD)',
              data: data.prices,
              borderColor: '#FFA500',
              backgroundColor: 'rgba(255,165,0,0.2)',
              fill: false,
              tension: 0.1,
              pointRadius: 0,
              yAxisID: 'y'   // default left y-axis
            },
            {
              type: 'bar',
              label: 'Volume (USD)',
              data: data.volumes,
              backgroundColor: 'rgba(255,165,0,0.3)',
              borderWidth: 0,
              yAxisID: 'y1',
              hidden: true    // start hidden; controlled by toggle
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 800  // ms for animations (for updates)
          },
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            tooltip: {
              titleColor: '#fff',
              bodyColor: '#fff',
              backgroundColor: '#2a2a2a',
              borderColor: '#444',
              borderWidth: 1,
              xAlign: 'center',
              yAlign: 'bottom',
              displayColors: false, // don't show box color in tooltip
              callbacks: {
                // Add a dollar sign to price in tooltip
                label: function(context) {
                  const datasetLabel = context.dataset.label || '';
                  let value = context.formattedValue;
                  if (datasetLabel.toLowerCase().includes('price')) {
                    value = '$' + value;
                  }
                  return datasetLabel + ': ' + value;
                }
              }
            },
            legend: {
              display: false  // no on-chart legend (we use external controls)
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                tooltipFormat: 'MMM dd, yyyy HH:mm'  // format for tooltip's x-value
              },
              grid: {
                color: '#444'
              },
              ticks: {
                color: '#cccccc',
                font: { size: 12 }
              }
            },
            y: {
              position: 'left',
              title: {
                display: true,
                text: 'Price (USD)',
                color: '#ffffff',
                font: { size: 13, weight: 'bold' }
              },
              grid: {
                color: '#444'
              },
              ticks: {
                color: '#ffffff',
                font: { size: 12 }
              }
            },
            y1: {
              position: 'right',
              title: {
                display: true,
                text: 'Volume (USD)',
                color: '#ffffff',
                font: { size: 13, weight: 'bold' }
              },
              grid: {
                drawOnChartArea: false,  // only draw grid lines for left y-axis
                color: '#444'
              },
              ticks: {
                color: '#ffffff',
                font: { size: 12 }
              },
              beginAtZero: true,
              display: false  // start hidden; enable when volume is toggled on
            }
          }
        }
      });
    }
    
    // Update chart data for a new time range
    async function updateChartRange(days) {
      const newData = await fetchCoinData(days);
      if (!newData) return;
      // Update datasets with new data
      chart.data.datasets[0].data = newData.prices;
      chart.data.datasets[1].data = newData.volumes;
      chart.update();  // animate to new data
    }
    
    // Event listeners for range buttons
    document.querySelectorAll('.range-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const days = btn.getAttribute('data-days');
        // Update active button styling
        document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // Fetch and update chart for new range
        await updateChartRange(days);
      });
    });
    
    // Event listener for volume toggle
    const volBtn = document.getElementById('volume-toggle');
    volBtn.addEventListener('click', () => {
      const volumeIndex = 1;  // dataset index for volume
      const currentlyVisible = chart.isDatasetVisible(volumeIndex);
      if (currentlyVisible) {
        // Currently showing volume, so hide it
        chart.setDatasetVisibility(volumeIndex, false);
        volBtn.textContent = 'Show Volume';
        // Hide the volume axis
        chart.options.scales.y1.display = false;
      } else {
        // Currently hidden, so show volume
        chart.setDatasetVisibility(volumeIndex, true);
        volBtn.textContent = 'Hide Volume';
        // Show the volume axis
        chart.options.scales.y1.display = true;
      }
      // Toggle active state styling for the button
      volBtn.classList.toggle('active');
      chart.update();
    });
    
    // Initial load: fetch default range (30 days) and initialize chart
    (async function(){
      const initialDays = 30;  // default to 1M view
      const initialData = await fetchCoinData(initialDays);
      if (initialData) {
        // Mark the corresponding range button as active (e.g., 1M which we set as default in HTML)
        // (Already done in HTML with the first button as active for 1M)
        initChart(initialData);
      }
    })();
  </script>
</body>
</html>
